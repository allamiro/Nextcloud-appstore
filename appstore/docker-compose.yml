version: "3.9"

services:
  db:
    image: postgres:16
    restart: unless-stopped
    env_file: .env
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - appstore-db-data:/var/lib/postgresql/data
    networks:
      - appstore-net

  app:
    build: .
    restart: unless-stopped
    env_file: .env
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT}
      SECRET_KEY: ${SECRET_KEY}
      DJANGO_SETTINGS_MODULE: ${DJANGO_SETTINGS_MODULE}
      LOAD_INITIAL_DATA: ${LOAD_INITIAL_DATA:-0}
      COMPILE_MESSAGES: ${COMPILE_MESSAGES:-0}
      GUNICORN_WORKERS: ${GUNICORN_WORKERS:-4}
      GUNICORN_TIMEOUT: ${GUNICORN_TIMEOUT:-120}
    volumes:
      # Your custom production settings
      - ./settings/production.py:/app/nextcloudappstore/settings/production.py:ro
      # Static & media (host-mounted so you can manage them)
      - ./static:/var/www/nextcloud-appstore/static
      - ./media:/var/www/nextcloud-appstore/media
      # Logs
      - ./logs/appstore.log:/app/appstore.log
    depends_on:
      - db
    networks:
      - appstore-net

  nginx:
    image: nginx:1.27-alpine
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./docker/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./static:/var/www/nextcloud-appstore/static:ro
      - ./media:/var/www/nextcloud-appstore/media:ro
    depends_on:
      - app
    networks:
      - appstore-net

volumes:
  appstore-db-data:

networks:
  appstore-net:
    driver: bridge
